<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Finapp</title>
    <meta name="description" content="Finapp HTML Mobile Template">
    <meta name="keywords"
        content="bootstrap, wallet, banking, fintech mobile template, cordova, phonegap, mobile, html, responsive" />
    <link rel="icon" type="image/png" href="assets/img/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/img/icon/192x192.png">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="manifest" href="__manifest.json">
    <style>
        .invalid-feedback {
            font-size: 0.85rem;
            color: #dc3545;
            display: none;
        }

        .is-invalid {
            border-color: #dc3545 !important;
        }
    </style>
</head>

<body>

    <!-- Loader -->
    <div id="loader">
        <img src="assets/img/loading-icon.png" alt="Loading icon" class="loading-icon">
    </div>

    <!-- App Capsule -->
    <div id="appCapsule">
        <input id="hiddenHostName" value="<%- site_root %>" type="hidden" />
        <input id="hiddenApiHostName" value="<%- api_host %>" type="hidden" />

        <div class="section mt-2 text-center mb-2">
            <h1 class="text-primary">Finapp</h1>
            <p>Sign in to your account</p>
        </div>

        <div class="section mb-5 p-2">
            <form id="loginForm" class="px-3" novalidate>
                <!-- Username -->
                <div class="form-group boxed">
                    <div class="input-wrapper">
                        <label class="label ps-1" for="username">Username</label>
                        <input type="text" class="form-control" id="username" placeholder="Your Username" autocomplete="off">
                        <div class="invalid-feedback" id="usernameError">Username is required</div>
                        <i class="clear-input">
                            <ion-icon name="close-circle"></ion-icon>
                        </i>
                    </div>
                </div>
                
                <!-- Password -->
                <div class="form-group boxed mb-1">
                    <div class="input-wrapper">
                        <label class="label ps-1" for="password">Password</label>
                        <input type="password" class="form-control" id="password" placeholder="Your Password" autocomplete="off">
                        <div class="invalid-feedback" id="passwordError">Password is required</div>
                        <div class="d-flex justify-content-end pt-1 pe-1">
                            <h5 href="/forgot-password" class="text-primary">Forgot Password?</h5>
                        </div>
                        <i class="clear-input">
                            <ion-icon name="close-circle"></ion-icon>
                        </i>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-100" style="margin-bottom: 18px;">Login</button>

                <div style="display: flex; justify-content: center; width: 100%;">
                    <div style="display: flex; align-items: center;">
                        <p>Don't have an account? <a href="/register" style="margin-left: 0.3rem;">Sign up</a></p>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- ========= JS Files ========= -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/lib/bootstrap.bundle.min.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script src="assets/js/plugins/splide/splide.min.js"></script>
    <script src="assets/js/base.js"></script>

    <!-- Custom Script -->
    <script>
        $(document).ready(function () {
            const $username = $("#username");
            const $password = $("#password");
            const $usernameError = $("#usernameError");
            const $passwordError = $("#passwordError");

            function showError($input, $errorDiv, message) {
                $input.addClass("is-invalid");
                $errorDiv.text(message).show();
            }

            function clearError($input, $errorDiv) {
                $input.removeClass("is-invalid");
                $errorDiv.hide();
            }

            $("#loginForm").on("submit", function (e) {
                e.preventDefault();

                const apiUrl = $("#hiddenApiHostName").val() + "/api/authenticate_user";
                const username = $username.val().trim();
                const password = $password.val().trim();

                // Reset errors
                clearError($username, $usernameError);
                clearError($password, $passwordError);

                let hasError = false;

                if (!username) {
                    showError($username, $usernameError, "Username is required.");
                    hasError = true;
                }

                if (!password) {
                    showError($password, $passwordError, "Password is required.");
                    hasError = true;
                }

                if (hasError) return;

                // Submit login request
                $.ajax({
                    url: apiUrl,
                    type: "POST",
                    data: {
                        user_name: username,
                        user_pass: password
                    },
                    dataType: 'json',
                    success: function (response) {
                        if (response.success === false) {
                            showError($username, $usernameError, "Invalid username or password.");
                            showError($password, $passwordError, "");
                        } else {
                            window.location.href = $("#hiddenHostName").val();
                        }
                    },
                    error: function () {
                        showError($username, $usernameError, "Server error. Try again later.");
                    }
                });
            });
        });
    </script>

</body>

</html>