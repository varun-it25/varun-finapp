<style>
  .is-invalid {
    border-color: red;
  }

  .error-message {
    color: red;
    font-size: 0.9em;
    margin-top: 4px;
    display: none;
  }
</style>

<input id="siteHost" value="<%- site_root %>" type="hidden" />
<input id="apiHost" value="<%- api_host %>" type="hidden" />

<!-- Header -->
<div class="appHeader">
  <div class="left">
    <a href="/" class="headerButton goBack">
      <ion-icon name="chevron-back-outline"></ion-icon>
    </a>
  </div>
  <div class="pageTitle">Deposit</div>
  <div class="right">
    <a href="app-notifications.html" class="headerButton">
      <ion-icon name="notifications-outline"></ion-icon>
      <span class="badge badge-danger">4</span>
    </a>
  </div>
</div>

<!-- App Content -->
<div id="appCapsule">
  <!-- Amount Section -->
  <div id="section-amount" class="section-screen">
    <div class="section my-4 mx-4">
      <h3>Amount</h3>
      <p>Enter the deposit amount (min: ₹50)</p>
      <div class="form-group basic">
        <input type="number" class="form-control" id="depositAmount" placeholder="₹ 50">
        <span id="amountError" class="error-message">Please enter a valid amount (min ₹50).</span>
      </div>
    </div>
    <div id="chipList" class="section mb-4 mx-4" style="margin-top: -10px;">
      <!-- Chips -->
      <span class="chip chip-outline py-2 px-3 mb-1 me-1" data-value="50">₹ 50</span>
      <span class="chip chip-outline py-2 px-3 me-1" data-value="100">₹ 100</span>
      <span class="chip chip-outline py-2 px-3" data-value="200">₹ 200</span>
      <span class="chip chip-outline py-2 px-3 me-1" data-value="500">₹ 500</span>
      <span class="chip chip-outline py-2 px-3 mb-1 me-1" data-value="1000">₹ 1 k</span>
      <span class="chip chip-outline py-2 px-3 me-1" data-value="2000">₹ 2 k</span>
      <span class="chip chip-outline py-2 px-3" data-value="5000">₹ 5 k</span>
      <span class="chip chip-outline py-2 px-3 me-1" data-value="10000">₹ 10 k</span>
      <span class="chip chip-outline py-2 px-3 me-1" data-value="20000">₹ 20 k</span>
      <span class="chip chip-outline py-2 px-3" data-value="30000">₹ 30 k</span>
    </div>
    <div class="section mx-4">
      <button type="button" id="btnNextAmount" class="btn btn-primary w-100">Next</button>
    </div>
  </div>

  <!-- QR Section -->
  <div id="section-qr" class="section-screen" style="display: none;">
    <div class="section my-4 mx-4">
      <h3>QR CODE</h3>
      <p>Scan this code for payment.</p>
      <img src="https://hexdocs.pm/qr_code/docs/qrcode.svg" id="qrImage" style="width: 100%;">
    </div>
    <div class="section mx-4 d-flex justify-content-between">
      <button type="button" id="btnBackQR" class="btn btn-outline-secondary w-25">Back</button>
      <button type="button" id="btnNextQR" class="btn btn-primary w-50">Next</button>
    </div>
  </div>

  <!-- UTR Section -->
  <div id="section-utr" class="section-screen" style="display: none;">
    <div class="section my-4 mx-4">
      <h3>UTR NO.</h3>
      <p>Enter the UTR no. to confirm the payment.</p>
      <div class="form-group basic">
        <input type="text" class="form-control" id="utrInput" placeholder="XXXXRCYYYYMMDD########">
        <span id="utrError" class="error-message">Enter valid UTR (20-30 alphanumeric characters).</span>
      </div>
    </div>
    <div class="section mx-4 d-flex justify-content-between">
      <button type="button" id="btnBackUTR" class="btn btn-outline-secondary w-25">Back</button>
      <button type="button" id="btnNextUTR" class="btn btn-primary w-50">Submit</button>
    </div>
  </div>

  <!-- Success Section -->
  <div id="section-success" class="section-screen" style="display: none;">
    <div class="section my-4 mx-4 text-center">
      <h3>Success</h3>
      <p>Your money has been deposited successfully.</p>
      <img src="https://static-00.iconduck.com/assets.00/success-icon-512x512-qdg1isa0.png" class="mt-2" style="width: 100px;">
    </div>
    <div class="section mx-2 mt-4 d-flex justify-content-between">
      <a href="/" class="w-50 me-1">
        <button type="button" class="btn btn-outline-secondary w-100">Home</button>
      </a>
      <a href="/trade" class="w-50 ms-1">
        <button type="button" class="btn btn-primary w-100">Trade</button>
      </a>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  $(document).ready(function () {
    const apiHost = $("#apiHost").val();
    const siteHost = $("#siteHost").val();

    const depositAmountInput = $("#depositAmount");
    const utrInput = $("#utrInput");
    const chipList = $("#chipList");
    const amountError = $("#amountError");
    const utrError = $("#utrError");

    function showSection(id) {
      $(".section-screen").hide();
      $(id).show();
    }

    function loadQRCode() {
      $.post(apiHost + "/api/site/settings", { setting_type: "QR" }, function (res) {
        if (res && res.length && res[0].qr_code) {
          const qrPath = res[0].qr_code.replace(/\\/g, "/");
          $("#qrImage").attr("src", apiHost + "/" + qrPath);
        }
      });
    }

    chipList.on("click", ".chip", function () {
      $(".chip").removeClass("chip-primary").addClass("chip-outline");
      $(this).removeClass("chip-outline").addClass("chip-primary");
      depositAmountInput.val($(this).data("value"));
      amountError.hide();
      depositAmountInput.removeClass("is-invalid");
    });

    depositAmountInput.on("input", function () {
      amountError.hide();
      $(this).removeClass("is-invalid");
    });

    $("#btnNextAmount").on("click", function () {
      const amount = parseFloat(depositAmountInput.val());
      if (isNaN(amount) || amount < 50) {
        depositAmountInput.addClass("is-invalid");
        amountError.show();
        return;
      }
      showSection("#section-qr");
      loadQRCode();
    });

    $("#btnBackQR").on("click", () => showSection("#section-amount"));
    $("#btnNextQR").on("click", () => {
      utrInput.val("");
      utrError.hide();
      utrInput.removeClass("is-invalid");
      showSection("#section-utr");
    });

    $("#btnBackUTR").on("click", () => showSection("#section-qr"));

    utrInput.on("input", function () {
      utrError.hide();
      utrInput.removeClass("is-invalid");
    });

    $("#btnNextUTR").on("click", function () {
      const utrVal = utrInput.val().trim();
      const isValid = /^[A-Za-z0-9]{20,30}$/.test(utrVal);

      if (!isValid) {
        utrInput.addClass("is-invalid");
        utrError.show();
        return;
      }

      showSection("#section-success");
    });

    depositAmountInput.on("keydown", function (e) {
      if (["e", "E", "+", "-", "."].includes(e.key)) {
        e.preventDefault();
      }
    });

    showSection("#section-amount");
  });
</script>